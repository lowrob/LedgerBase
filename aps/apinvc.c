/*-----------------------------------------------------------------------
Source Name: apinvc.c
System     : Accounts Payables.
Created  On: 23rd November 89.
Created  By: T AMARENDRA.

COBOL Source(s): cp030---07

DESCRIPTION:
	This Program shows main screen of Invoice entry. User can select
	different options from here.

MODIFICATIONS:        

Programmer     YY/MM/DD       Description of modification
~~~~~~~~~~     ~~~~~~~~       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
J.PRESCOTT     91/02/06       Add a return to confirm to make the menu option
			      work like the menuing system.
P.ralph	       91/02/07       Prompt user if reports should be printed
L.Robichaud    93/07/07	      Execute function to see if a cheque run is in 
			      process before doing anything else.
------------------------------------------------------------------------*/

#define	MAIN		/* Main program. This is to declare Switches */
#define MAINFL		APINVOICE	/* main file used */

#include <stdio.h>
#include <cfomstrc.h>
#include <bfs_defs.h>
#include <bfs_recs.h>
#include <apinvc.h>

#define	SYSTEM		"ACCOUNTS PAYABLE"	/* Sub System Name */
#define MOD_DATE	"23-JAN-90"		/* Program Last Modified */

#ifdef ENGLISH
#define TRANSENTRY	'1'
#define OPENITEM	'2'
#define RELEASEHB	'3'
#define PAYMENT		'4'
#define PRINTSUMMARY	'D'
#define EXITOPT		'E'
#define YES		'Y'
#else
#define TRANSENTRY	'1'
#define OPENITEM	'2'
#define RELEASEHB	'3'
#define PAYMENT		'4'
#define PRINTSUMMARY	'A'
#define EXITOPT		'F'
#define YES		'O'
#endif

/* PROFOM Releted declarations */

#define	SCR_NAME	"apinvc"	/* PROFOM screen Name */

/* PROFOM Screen STH file */

/* Field PROFOM numbers */

#define	SCR_END_FLD	1300	/* Last Field of the screen */
#define	OPTION_FLD	1100	/* Option: */

/* apinvc.sth - header for C structure generated by PROFOM EDITOR */

struct	s_struct	{

	char	s_pgm[11];	/* STRING XXXXXXXXXX Field 100 */
	long	s_rundate;	/* DATE YYYYFMMFDD Field 300 */
	char	s_option[2];	/* STRING X Field 1100 */
	char	s_mesg[78];	/* STRING X[77] Field 1200 */
	char	s_resp[2];	/* STRING X Field 1300 */
} ;

static	struct	s_struct  s_sth;	/* Main SCR's PROFOM Structure */

struct	stat_rec	sr ;

/* The following two variables are used while calling execute() */
int	Argc;
char	**Argv;

/*------------------------------------------------------------------------*/

main(argc,argv)
int	argc;
char	*argv[];
{
	int	err, numprocess;

	if(argc < 2){
#ifdef  DEVELOP
		printf("MAIN ARGUMENTS ARE NOT PROPER\n");
		printf("Usage: %s {-tTerminal Name} {-dDist#} [{-sSwitches}]\n",
			argv[0]);
#endif
		exit(1);
	}

	Argc = argc;
	Argv = argv;

	err = Initialize(argc,argv) ;	/* Initialize Variables , DBH
						Environment and PROFOM */

#ifndef DOS
	/* see if cheque run or cancelation in process */
	numprocess = chqcheck(); 
	if(numprocess == ERROR){
		DispError("Error Occured Checking Active Processes");
		err=ERROR;
	}
	else if(numprocess > 0){
		DispError("Can Not Proceed, Cheque Run In Progress");
		close_dbh();
		exit(0);
	}
#endif

	if(err == NOERROR) err = Process();	/* Initiate Process */

	CloseProcess() ;

	if(err != NOERROR)exit(1);
	exit(0);
}	/* main() */
/*-------------------------------------------------------------------*/
/* Initialize Variables, PROFOM, DBH etc. */
static	int
Initialize(argc, argv)
int	argc ;
char	*argv[] ;
{
	int	i ;

	/*
	*	Initialize DBH Environment
	*/
	strncpy(SYS_NAME,SYSTEM,50);	/* Sub system name */
	strncpy(CHNG_DATE,MOD_DATE,10);	/* Modification Date */

	proc_switch(argc, argv, MAINFL) ;	/* Process Switches */

	/*
	*	Initialize PROFOM & Menu Screen
	*/
	STRCPY(sr.termnm,terminal);	/* Copy Terminal Name */
	fomin(&sr);
	ret(err_chk(&sr)) ;		/* Check for PROFOM Error */
	fomcf(1,1);			/* Enable Snap screen option */

	SetScreen() ;

	/* Initialize SCR */
	STRCPY(s_sth.s_pgm,PROG_NAME);
	s_sth.s_rundate = get_date();	/* get Today's Date in YYYYMMDD format*/
	s_sth.s_mesg[0] = HV_CHAR ;
	s_sth.s_resp[0] = HV_CHAR ;

	ret( WriteFields(1, 0) ) ;

	/*
	*	Get The Parameter Record
	*/
	i = get_param(&pa_rec, BROWSE, 1, e_mesg) ;
	if(i == ERROR) {
		DispError(e_mesg);
		return(ERROR) ;
	}
	else if(i == UNDEF) {
#ifdef ENGLISH
		DispError("Parameters Are Not Setup..");
#else
		DispError("Parametres ne sont pas etablis..");
#endif
		return(ERROR) ;
	}

	/*
	*	Initialize Summary totals variables
	*/

	for(i = 0 ; i < 4 ; i++) {
		CR_totals[i].O_gross = 0.0 ;
		CR_totals[i].O_disc  = 0.0 ;
		CR_totals[i].C_gross = 0.0 ;
		CR_totals[i].C_disc  = 0.0 ;

		DB_totals[i].O_gross = 0.0 ;
		DB_totals[i].O_disc  = 0.0 ;
		DB_totals[i].C_gross = 0.0 ;
		DB_totals[i].C_disc  = 0.0 ;
	}

	RelseHB.no_trans = 0 ;
	RelseHB.tot_amt  = 0 ;

	HBchanges.no_trans = 0 ;
	HBchanges.tot_amt  = 0 ;

	DiscChanges.no_trans = 0 ;
	DiscChanges.tot_amt  = 0 ;

	StopPmnt.no_trans = 0 ;
	StopPmnt.tot_amt  = 0 ;

	PartPmnt.no_trans = 0 ;
	PartPmnt.tot_amt  = 0 ;

	ManCheques.no_trans = 0 ;
	ManCheques.tot_amt  = 0 ;

	TotalsUpdated = 0 ;

	return(NOERROR) ;
}	/* Initialize() */
/*-------------------------------------------------------------------*/
/* Get Option: from user and call corresponding function */
static	int
Process()
{
	int err;

	for( ; ; ){
		/* Get the Option: from the user */
		if((err = ReadOption()) != NOERROR) return(err) ;

		err = ProcOption() ;	/* Process Option */

		if(QUIT == err)		return(NOERROR) ;	/* Exit */
		if(PROFOM_ERR == err)	return(PROFOM_ERR);  /* PROFOM ERROR */
		if(DBH_ERR == err) {
			DispError(e_mesg);
#ifdef ENGLISH
			sprintf(e_mesg,"%s %d Dberror: %d Errno: %d",
				"System Error... Iserror:",
				iserror, dberror, errno);
#else
			sprintf(e_mesg,"%s %d Dberror: %d Errno: %d",
				"Erreur du systeme... Iserror:",
				iserror, dberror, errno);
#endif
			DispError(e_mesg);
			return(DBH_ERR);	/* DBH ERROR */
		}
	}      /*   end of the for( ; ; )       */
}	/* Process() */
/*----------------------------------------------------------------*/
/* Close necessary files and environment before exiting program */
static	int
CloseProcess()
{
	int opt;

	close_dbh();	/* Close DBH(files) */
	/* Print Summary and Transaction Details Reports */


#ifdef ENGLISH
		opt = GetOption("Do you want audit report (Y/N)?", "YN") ;
#else
		opt = GetOption("Vous voulez un rapport de verification (O/N)?",

								 "ON") ;
#endif
		if(opt == YES) {

#ifdef ENGLISH
			opt = GetOption("Confirm report (Y/N)?", "YN") ;
#else
			opt = GetOption("Confirmer rapport (O/N)?", "ON") ;
#endif
			if(opt == YES) {

				fflush(stdout);
#ifdef ENGLISH
				STRCPY(s_sth.s_mesg,
					"Please Wait... Compiling Reports");
#else
				STRCPY(s_sth.s_mesg,
				   "Attendez S.V.P...Compilation des rapports");
#endif
				ShowMesg() ;
				fflush(stdout);

				if(TotalsUpdated) {
					/* Print Partition Summary */
					PrintSummary("P") ;	

				}
				ApInvcDetails(); /* Print Transaction Details */
#ifdef	i386
				system("lp -c -o nobanner date_audit.dat");
#else
				system("lpr -b date_audit.dat");
#endif
				unlink("date_audit.dat");
			}
		}


	/* Set terminal back to normal mode from PROFOM */
	fomcs();
	fomrt();

	free_audit() ;	/* Free memory, which is allocated in rite_audit() */
	close_dbh();	/* Close DBH(files) */

	return(NOERROR) ;
}	/* CloseProcess() */
/*----------------------------------------------------------------*/
/* Copy Current Scr to PROFOM status structure and set screen paramaters to
   Current Screen */
static	int
SetScreen()
{
	CurrentScr = (char*)&s_sth ;
	END_FLD    = SCR_END_FLD ;

	/* move screen name to Profom status structure */
	STRCPY(sr.scrnam,NFM_PATH);
	strcat(sr.scrnam,SCR_NAME) ;

	return(NOERROR) ;
}
/*----------------------------------------------------------------*/
/* Get the option from the user */
static	int
ReadOption()
{
	char	prev_option[2];
	int	fld_nbr1;		/* field number to highlight */
	int	fld_nbr2;		/* field number to de-highlight */

	for( ; ; ) {
		fomca1(OPTION_FLD,19,2); /* enable dup control */

		sr.nextfld = sr.endfld = OPTION_FLD;
		fomud( (char *)&s_sth);
		ret(err_chk(&sr));	/* Check for PROFOM error */
		s_sth.s_option[0]=LV_CHAR;

		/* Read Option: field to get the option */
		sr.nextfld = sr.endfld = OPTION_FLD ;
		fomrd( (char *)&s_sth );
		ret(err_chk(&sr));	/* Check for PROFOM error */

		fomca1(OPTION_FLD,19,0); /* disable dup control */

		switch(s_sth.s_option[0]) {
			case EXITOPT:
				fld_nbr1 = 500;
				break;
			case TRANSENTRY:
				fld_nbr1 = 600;
				break;
			case OPENITEM:
				fld_nbr1 = 700;
				break;
			case RELEASEHB:
				fld_nbr1 = 800;
				break;
			case PAYMENT:
				fld_nbr1 = 900;
				break;
			case PRINTSUMMARY:
				fld_nbr1 = 1000;
				break;
			default:
				fomer("Invalid selection");
				fld_nbr1 = 0;
				break;
		}

		switch(prev_option[0]) {
			case EXITOPT:
				fld_nbr2 = 500;
				break;
			case TRANSENTRY:
				fld_nbr2 = 600;
				break;
			case OPENITEM:
				fld_nbr2 = 700;
				break;
			case RELEASEHB:
				fld_nbr2 = 800;
				break;
			case PAYMENT:
				fld_nbr2 = 900;
				break;
			case PRINTSUMMARY:
				fld_nbr2 = 1000;
				break;
			default:
				fld_nbr2 = 0;
				break;
		}

		if(fld_nbr2!=0) 
			fomca1(fld_nbr2,9,4);	/* turn off highlight */
		if(fld_nbr1!=0) 
			fomca1(fld_nbr1,9,2);	/* turn on highlight */

		if(prev_option[0] != s_sth.s_option[0] && fld_nbr1 != 0) {
#ifdef ENGLISH
			fomer("Enter RETURN to confirm");
#else
			fomer("Appuyer sur RETURN pour confirmer");
#endif
			prev_option[0] = s_sth.s_option[0];
		}
		else if(sr.fillcode == FIL_DUP) {
				break;
		}
		else {
#ifdef ENGLISH
			fomer("Enter RETURN to confirm");
#else
			fomer("Appuyer sur RETURN pour confirmer");
#endif
			prev_option[0] = s_sth.s_option[0];
		}
	}
	return(NOERROR) ;
}	/* ReadOption() */
/*----------------------------------------------------------------*/
/* Process the user selected OPTION: */
static	int
ProcOption()
{
	int	err ;

	switch (s_sth.s_option[0]) {
	case TRANSENTRY  :		/* Transaction Entry */
		err = TransEntry() ;
		break ;
	case OPENITEM  :		/* Open Item Maintenance */
		err = OpenItemMaintenance() ;
		break ;
	case RELEASEHB  :
		err = ReleaseHoldback() ;
		break ;
	case PAYMENT  :
		err = Payment() ;
		break ;
	case PRINTSUMMARY  :
		err = PrintSummary("D") ;
		break ;
	case EXITOPT  :			/* Exit */
		return( QUIT ) ;
	}  /*   end of the switch statement */
	if(err == PROFOM_ERR || err == DBH_ERR) return(err) ;
	SetScreen() ;	/* Set to Current Screen */
	return(NOERROR) ;
}	/* ProcOption() */

/*-------------------- E n d   O f   P r o g r a m ---------------------*/

