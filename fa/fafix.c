/*-----------------------------------------------------------------------------
		Program name  : fafix.c
		System        : Budgetary Financial System.
		Subsystem     : Fixed Assets System 
		Date Created  : 1990-DEC-03
		Created By    : C.Leadbeater 

-------------------------------------------------------------------------------
DESCRIPTION:

	This program will correct any famast records that were converted
	incorrectly from the previous financial systems COBOL files.
	Some records may have an incorrect receipt date.

	Ex. 170889 might have been converted to 19170889 instead of 19890817.

	This will ignore records with receipt dates greater than 19900101 or 
	receipt dates equal to 0.

-------------------------------------------------------------------------------
MODIFICATIONS:

Date            Programmer     Description of modification
YYYY/MM/DD      __________     ___________________________

-----------------------------------------------------------------------------*/

#define MAIN
#define MAINFL	FAMAST

#include <bfs_defs.h>
#include <bfs_recs.h>
#include <cfomstrc.h>
#include <bfs_fa.h>

#define SYSTEM		"FIXED ASSETS"
#define MOD_DATE	"03-DEC-90"
#define SCREEN_NAME	"famast"
#define ESCAPE		12	/* flag indicates discontinuation of entries */
#define LOW 		-1
#define HIGH 		 1
#define HL_CHAR(VAL)	(VAL==HIGH) ? HV_CHAR : LV_CHAR

/* fa_maint.sth - header for C structure generated by PROFOM EDITOR */

struct	fa_struct	{
	char	s_progname[11];	/* 100 program name */
	long	s_rundt;	/* 300 system date */
	char	s_fn[2];	/* 400 function */
	short	s_costcen;	/* 500 cost centre# */
	long	s_itemid;	/* 600 item id */
	short	s_fld_no;	/* 700 field# field for editing */
	char	s_desc[36];	/* 900 description of the item */
	char	s_type[5];	/* 1000 fixed asset item type code */
	char	s_typname[16];	/* 1100 fixed asset item type name */
	char	s_sno[13];	/* 1200 model or s# under the type */
	char	s_dept[5];	/* 1300 department number */
	char	s_roomno[6];	/* 1400 room number */
	char	s_cond[2];	/* 1500 condition code */
	char	s_condexp[10];	/* 1600 condition explanation */
	char	s_suppname[21];	/* 1700 supplier name */
	char	s_invc[11];	/* 1800 invoice number */
	short	s_curcostcen;	/* 1850 current location of fixed asset */
	long	s_rectdate;	/* 1900 date of receipt */
	long	s_qty;		/* 2000 quantity */
	double	s_rate;		/* 2100 rate */
	double	s_value;	/* 2200 value of the stock */
	char	s_mesg[77];	/* 2300 message field */
	char	s_resp[2];	/* 2400 response field */
};

struct fa_struct	s_rec;	/* screen record */
struct stat_rec 	sr;	/* profom status record */

Fa_rec		fa_mast;	/* Fixed Asset Item master file */

int retval;	/* Global variable to store function values */

static	long	new_rectdate;		
static	long	num_changed = 0;
static	long	num_records = 0;
static 	char 	e_mesg[80]; 	/* to store error messages */

/*------------------------------------------------------------------*/
/* Initialize profom fields, call entry procedures */
main( argc, argv )
int argc;
char *argv[];
{
	strncpy( SYS_NAME, SYSTEM, 50 ); /* Module name */
	strncpy( CHNG_DATE, MOD_DATE, 10 );/* Last date of change */

	proc_switch( argc,argv,MAINFL );/* process the switches */

	if( Initialize()<0 )	/* Initialize profom enviroment */
		exit(-1);
	retval = Process();	/* Interact with the user */
	CleanExit();
}
/*------------------------------------------------------------------*/

CleanExit()
{
	/* clear and exit the screen , close files & exit program */
	fomcs();
	fomrt();
	close_dbh();
	exit(retval);
}
/*------------------------------------------------------------------*/

Initialize()
{
	/* initialize the profom status variables */
	STRCPY( sr.scrnam, NFM_PATH );
	strcat( sr.scrnam, SCREEN_NAME );
	STRCPY( sr.termnm, terminal );

	/* initialize the fields and the profom screen */
	if( FillScrHdg()<0 ) 			return(-1);
	if( FillKeyFields( HIGH )<0 ) 		return(-1);
	if( FillField( HIGH )<0 ) 		return(-1);
	if( FillNonKeyFlds( HIGH )<0 ) 		return(-1);
	if( FillMesgRespFlds( HIGH )<0 ) 	return(-1);
	if( InitProfom()<0 ){
		fomcs();
		fomrt();
		return(-1);
	}
	return(0);
}
/*------------------------------------------------------------------*/
/* Fill the screen heading fields: the program name and the date */
FillScrHdg()
{
	STRCPY( s_rec.s_progname, PROG_NAME );
	s_rec.s_rundt = get_date();
	s_rec.s_fn[0]=HV_CHAR;
	return(0);
}
/*------------------------------------------------------------------*/
/* Fill the keyfields with high or low values */
FillKeyFields( value )
short value;
{
	s_rec.s_costcen = value * HV_SHORT;
	s_rec.s_itemid = value * HV_LONG;

	return(0);
}
/*------------------------------------------------------------------*/
/* Fill the field# field with high/low values */
FillField( value )
short value;
{
	s_rec.s_fld_no = value * HV_SHORT;
	return(0);
}
/*------------------------------------------------------------------*/
/* Fill the non key fields with high/low values */
FillNonKeyFlds( value )
short value;
{
	s_rec.s_desc[0] 	= HL_CHAR(value);
	s_rec.s_type[0] 	= HL_CHAR(value);
	s_rec.s_typname[0] 	= HL_CHAR(value);
	s_rec.s_sno[0] 		= HL_CHAR(value);
	s_rec.s_dept[0] 	= HL_CHAR(value);
	s_rec.s_roomno[0]	= HL_CHAR(value);
	s_rec.s_cond[0] 	= HL_CHAR(value);
	s_rec.s_condexp[0] 	= HL_CHAR(value);
	s_rec.s_suppname[0] 	= HL_CHAR(value);
	s_rec.s_invc[0] 	= HL_CHAR(value);
	s_rec.s_curcostcen	= value * HV_SHORT;
	s_rec.s_rectdate	= value * HV_LONG;
	s_rec.s_qty		= value * HV_LONG;
	s_rec.s_rate 		= value * HV_DOUBLE;
	s_rec.s_value 		= value * HV_DOUBLE;

	return(0);
}
/*------------------------------------------------------------------*/
/* Fill the message and response fields with high or low values */
FillMesgRespFlds( value )
short value;
{
	s_rec.s_mesg[0] = HL_CHAR(value);
	s_rec.s_resp[0] = HL_CHAR(value);
	return(0);
}
/*------------------------------------------------------------------*/
/* initialize the profom and the screen */
InitProfom()
{
	fomin( &sr );			/* initialize profom */
	ret( err_chk(&sr) );		/* if profom error return */
	if( WriteFields(1,0)<0 )	/* Write all fields once */
		return(-1);
	fomcf(1,1);			/* Enable snap-screen option */
	return(0);
}

/*------------------------------------------------------------------*/
WriteFields( start,end )	/* write the given range of fields */
int start, end;			/* start & end profom field numbers */
{
	sr.nextfld = start;
	sr.endfld = end;
	fomwr( (char *)&s_rec );
	ret( err_chk(&sr) );
	return(0);
}

/*------------------------------------------------------------------*/
/* Accept user's option and call the corresponding routine in a loop */
Process()
{
		/* Initialize the key fields to zeros. */
	s_rec.s_costcen = 0;
	s_rec.s_itemid = 0;

	retval = ChangeRecord();
	
	roll_back(e_mesg);
	if( retval<0 )
		return(-1);
	if( retval<0 ){
		fomen(e_mesg);
		get();
	}
	if( retval==DBH_ERR )
		return(retval);
}
/*------------------------------------------------------------------*/

ChangeRecord()	/* Change an existing record */
{

	for(;;) {
			/* Get the record & display it */
		
		num_records++;	
		retval = Inquiry();
		if( retval<0 )	return(retval);

		if( retval==EFL)
			return(retval);

			/* Allow changes on the record fields */
	
		retval = CheckRcptDt();

		if( retval<0 )	return(retval);
		if( retval==ESCAPE ){		/* no changes to this record */
			roll_back(e_mesg);	/* release locked record     */
			continue;
		}
		else {
				/* Write the updated record */
			if( WriteSession( UPDATE )<0 ) return(-1);
		
			num_changed++;	
		}

	}
	return(0);
}

/*------------------------------------------------------------------*/

Inquiry()	/* Screen inquiry, sequential */
{
		/* access is sequential, so get next record from file */
	retval = GetNextRec( FORWARD );	/* Get next rec */
	if(retval==EFL)
		return(retval);
	
	if( retval<0 ){	/* errors in reading */
		fomen(e_mesg);
		get();
		return(-1);
	}
	
		/* Write the key fields on to the screen */

	s_rec.s_costcen = fa_mast.fa_costcen;
	s_rec.s_itemid = fa_mast.fa_itemid;
	if( WriteFields(500,600)<0 )
		return(-1);

	return( DisplayRecord() );	
}

/*------------------------------------------------------------------*/

GetNextRec(direction)	/* Read the next record in the specified direction */
int	direction;
{
	if( flg_start(FAMAST)!=direction ){ 	/* file access mode changed */
		fa_mast.fa_costcen = s_rec.s_costcen;
		fa_mast.fa_itemid = s_rec.s_itemid;
		fa_mast.fa_itemid++;
		flg_reset(FAMAST);
	}
	/* Read the next record from famast file */
	retval = get_n_famast( &fa_mast, UPDATE, 0, direction, e_mesg );
	if( retval==EFL ){
		sprintf(e_mesg,"Number of Records Changed: %ld (of %ld read),  Press any key to exit",num_changed, num_records);
		fomen(e_mesg);
		get();
		flg_reset(FAMAST);
		return(EFL);
	}
	if( retval!=NOERROR ){
		fomen(e_mesg);	
		get();
		return(retval);
	}
	return(0);
}

/*------------------------------------------------------------------*/

DisplayRecord()	/* Get and display the header and item records */
{
	s_rec.s_costcen = fa_mast.fa_costcen ; 
	s_rec.s_itemid = fa_mast.fa_itemid ; 
	STRCPY( s_rec.s_desc, fa_mast.fa_desc );
	STRCPY( s_rec.s_type, fa_mast.fa_type );
	STRCPY( s_rec.s_sno, fa_mast.fa_sno );
	STRCPY( s_rec.s_dept, fa_mast.fa_dept );
	STRCPY( s_rec.s_roomno, fa_mast.fa_roomno );
	STRCPY( s_rec.s_cond, fa_mast.fa_cond );
	STRCPY( s_rec.s_suppname, fa_mast.fa_suppname );
	STRCPY( s_rec.s_invc, fa_mast.fa_invc );
	s_rec.s_curcostcen = fa_mast.fa_curcostcen;
	s_rec.s_rectdate = fa_mast.fa_rectdate ; 
	s_rec.s_qty = fa_mast.fa_qty ; 
	s_rec.s_rate = fa_mast.fa_rate ; 
	s_rec.s_value = fa_mast.fa_value ; 

	return(0);
}

/*-----------------------------------------------------------------------*/
CheckRcptDt()
{

	if( (fa_mast.fa_rectdate > 19900000) || (fa_mast.fa_rectdate == 0) )
		return (ESCAPE);    

	retval = ChangeDate(fa_mast.fa_rectdate);	
	if( retval == ESCAPE )	return(retval);

	s_rec.s_rectdate = new_rectdate;

	if( WriteFields(1900,1900) < 0 )
		return(-1);

	return(0);
}

/*-----------------------------------------------------------------------*/

ChangeDate(date_in)	/* Fixes date from 19DDMMYY to 19YYMMDD */ 
long	date_in;
{
	int	i, j, c;
	char	temp_date[10];
	char	date_out[10];

		/* convert long variable to character string */

	i = 0;
	do {
		temp_date[i++] = date_in % 10 + '0';
	} while(( date_in /= 10) > 0);

	temp_date[i] = '\0';

		/* reverse string to correct order */

	for( i=0, j = strlen(temp_date)-1; i < j; i++, j--) {
		c = temp_date[i];
		temp_date[i] = temp_date[j];
		temp_date[j] = c;
	}

		/* change only if day is not valid */
		
	if( temp_date[6] <= '3')	return(ESCAPE); 

		/* swap appropriate characters */

	date_out[0]=temp_date[0];  /* 1 */
	date_out[1]=temp_date[1];  /* 9 */ 
	date_out[2]=temp_date[6];  /* D  to  Y */
	date_out[3]=temp_date[7];  /* D  to  Y */
	date_out[4]=temp_date[4];  /* M */	
	date_out[5]=temp_date[5];  /* M */	
	date_out[6]=temp_date[2];  /* Y  to  D */	
	date_out[7]=temp_date[3];  /* Y  to  D */	
	date_out[8]=temp_date[8];

		/* Convert back to long from character string */

	new_rectdate = 0;

	for (i=0; date_out[i] >= '0' && date_out[i] <= '9'; i++)
		new_rectdate = 10 * new_rectdate + date_out[i] - '0';

	return(NOERROR);
}

/*-----------------------------------------------------------------------*/

WriteSession()	/* Write the stock master record */
{
	fa_mast.fa_costcen = s_rec.s_costcen;
	fa_mast.fa_itemid = s_rec.s_itemid;
	STRCPY( fa_mast.fa_desc, s_rec.s_desc );
	STRCPY( fa_mast.fa_type, s_rec.s_type );
	STRCPY( fa_mast.fa_sno, s_rec.s_sno );
	STRCPY( fa_mast.fa_dept, s_rec.s_dept );
	STRCPY( fa_mast.fa_roomno, s_rec.s_roomno );
	STRCPY( fa_mast.fa_cond, s_rec.s_cond );
	STRCPY( fa_mast.fa_suppname, s_rec.s_suppname );
	STRCPY( fa_mast.fa_invc, s_rec.s_invc );
	fa_mast.fa_curcostcen = s_rec.s_curcostcen;
	fa_mast.fa_rectdate = new_rectdate;
	fa_mast.fa_qty = s_rec.s_qty;
	fa_mast.fa_rate = s_rec.s_rate;
	fa_mast.fa_value = s_rec.s_value;
	
	retval = put_famast( &fa_mast, UPDATE, e_mesg );
	if( retval!=NOERROR ){
		fomen(e_mesg);
		get();
		roll_back(e_mesg);
		return(retval);
	}
	if( commit(e_mesg)<0 ){
		fomen(e_mesg);
		get();
		return(-1);
	}
	return(0);
}
/*---------------------- END OF PROGRAM ---------------------------------*/

